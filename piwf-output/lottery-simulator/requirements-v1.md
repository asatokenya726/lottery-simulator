# 宝くじシミュレーター 要件定義書 v1.1
> MVP開発期間: 3週間（15営業日）
> 最終更新: 2026-02-10

---

## 変更履歴サマリー（v1 → v1.1）

| 項目 | 変更前 | 変更後 | 理由（指摘者） |
|---|---|---|---|
| S-04 エラーハンドリング | Should | Must（M-13） | NFR-06との矛盾解消（要件レビュー B-1） |
| S-03 データリセット | Should | Must（M-14） | クライアント完結型アプリで初期化手段は必須（要件レビュー I-1） |
| M-05 当選演出 | 等級別9パターン（2日） | 当選/ハズレ2段階（1日） | 工数バッファ確保のため簡素化（スコープレビュー B-4, I-5） |
| GameState | winCountByLevel, updatedAt なし | 追加 | M-07の等級別当選回数に必須（データレビュー B-2, B-3） |
| M-06 資金補給 | 「0時に補給」 | 「0時以降の初回アクセス時に日付判定して補給」 | クライアント完結の制約を明確化（要件レビュー I-4） |
| M-02 残高不足時 | 未定義 | ボタン無効化+補給誘導表示 | UX上必須（要件レビュー I-3） |
| MVP期間 | 「2-3週間」/「2-4週間」混在 | 「3週間（15営業日）」統一 | 表記揺れ解消（スコープレビュー I-8） |
| セクション7 | 依存関係なし、削減候補なし | 追加 | 実装順序とリスク対策（スコープレビュー I-6, I-7） |
| データモデル | リレーション未明示 | 追加 | 設計の明確化（データレビュー I-2, I-10） |

---

## 申し送り消化（Phase 0 → Phase 1）

| # | 指摘事項 | ランク | ステータス |
|---|---------|--------|----------|
| 1 | SNSシェア機能はMVPではテキストベースを優先し、画像生成の方針はPhase 1で確定すること | 重要 | **完了** — MVPはテキストシェアのみ。固定OGP画像をセット。動的画像生成はv2以降 |

---

## 1. 機能要件（Must / Should / Could）

### Must（MVP必須 — これがないとリリースしない）

| # | 機能 | 詳細 |
|---|------|------|
| M-01 | ゲーム内通貨管理 | 通貨「ぃえん」で所持金を管理。初期資金100,000ぃえん。常時残高表示 |
| M-02 | 10連ガチャ（宝くじ10枚購入） | 1枚300ぃえん×10枚=3,000ぃえんで10連購入。年末ジャンボの実確率で抽選。**残高不足時はボタン無効化（disabled）し、「資金が足りません。0時に補給されます」のメッセージを表示** |
| M-03 | 抽選ロジック | 2024年末ジャンボの公式確率テーブルに基づく重み付きランダム抽選。**実装は本数/ユニットの整数比率による重み付き抽選とする** |
| M-04 | 当選結果表示 | 10枚分の結果を一覧表示。当選等級・金額を明示 |
| M-05 | 当選演出（簡易版） | **当選/ハズレの2段階演出**（当選時: 背景色変化+テキスト強調、ハズレ: 控えめ表示）。スキップ可能。**等級別の派手な演出はShould（S-03）に移行** |
| M-06 | 毎日0時の資金補給 | 残高3,000ぃえん未満の場合、30,000ぃえんを補給。1日1回制限。**補給判定は0時（JST）以降の初回アクセス時にlastRefillDateを確認して実行する（クライアント側日付判定）** |
| M-07 | 累計収支表示 | 累計購入額・当選額・回収率・等級別当選回数を表示。**集計値はGameStateに保持し、DrawHistoryの件数制限に依存しない** |
| M-08 | ギャンブル依存注意喚起 | 「シミュレーションです」の常時表示、相談窓口リンク、初回注意事項表示 |
| M-09 | 利用規約・免責表示 | 利用規約ページ。シミュレーションであること・換金不可の明記 |
| M-10 | レスポンシブデザイン | モバイルファースト。375px〜1920px対応 |
| M-11 | データ永続化 | LocalStorageにゲーム状態を保存。ブラウザを閉じても継続可能 |
| M-12 | SEO/OGP基本対応 | title/meta description/OGPタグ/favicon設定 |
| M-13 | エラーハンドリング | LocalStorage非対応時の警告表示（セッション中はメモリで動作）、データ破損時の自動リセット |
| M-14 | データリセット機能 | 確認ダイアログ付きで全データを初期化。初回アクセスと同じ状態に復帰 |

### Should（あると体験が向上 — 工数に余裕があれば実装）

| # | 機能 | 詳細 |
|---|------|------|
| S-01 | SNSシェア（テキスト） | 「宝くじシミュレーターで○等当たった!」+ URL をX(Twitter)にシェア |
| S-02 | 当選履歴一覧 | 過去の10連結果を一覧で閲覧可能。直近100件保持 |
| S-03 | 等級別当選演出 | M-05の拡張。1等は派手なアニメーション、高額当選ほど演出を差別化（CSSアニメーション） |

### Could（将来版 — MVPには含めない）

| # | 機能 | 詳細 |
|---|------|------|
| C-01 | 複数宝くじ種類 | ロト6/ロト7/サマージャンボ等の追加 |
| C-02 | ガチャ景品（コレクション） | 当選時にコレクションアイテムを獲得 |
| C-03 | ユーザー間フリマ | 景品の売買機能 |
| C-04 | ランキング/リーダーボード | 累計当選額ランキング |
| C-05 | 動的シェア画像生成 | 結果ごとにOGP画像を動的生成 |
| C-06 | ログインボーナス/実績バッジ | リテンション施策 |
| C-07 | アクセス解析 | Google Analytics等の導入 |
| C-08 | プレイ時間通知 | 長時間プレイへの注意喚起ポップアップ |

---

## 2. 宝くじ確率テーブル（2024年末ジャンボ準拠）

1ユニット = 20,000,000枚、1枚 = 300ぃえん

| 等級 | 当選金額（ぃえん） | 本数/ユニット | 確率 | 確率（小数） |
|------|------------------|-------------|------|------------|
| 1等 | 700,000,000 | 1 | 1/20,000,000 | 0.000005% |
| 1等前後賞 | 150,000,000 | 2 | 1/10,000,000 | 0.00001% |
| 1等組違い賞 | 100,000 | 199 | 約1/100,503 | 0.000995% |
| 2等 | 10,000,000 | 8 | 1/2,500,000 | 0.00004% |
| 3等 | 1,000,000 | 400 | 1/50,000 | 0.002% |
| 4等 | 50,000 | 2,000 | 1/10,000 | 0.01% |
| 5等 | 10,000 | 20,000 | 1/1,000 | 0.1% |
| 6等 | 3,000 | 200,000 | 1/100 | 1% |
| 7等 | 300 | 2,000,000 | 1/10 | 10% |
| ハズレ | 0 | 17,777,390 | 約88.89% | 88.89% |

**還元率**: 約46.9%（1ユニットあたり）

**実装上の注意**:
- 前後賞は本来「番号の前後」だが、シミュレーターでは独立した確率として扱う
- 組違い賞も同様に独立した確率として扱う
- 確率テーブルは設定ファイルとして外部化し、将来の種類追加に備える
- **抽選実装は本数/ユニットの整数比率による重み付き抽選とする（浮動小数点精度の問題を回避）**

---

## 3. ゲーム内通貨設計

| 項目 | 値 |
|------|-----|
| 通貨名 | ぃえん |
| 初期資金 | 100,000ぃえん（10連ガチャ約33回分） |
| 1枚の価格 | 300ぃえん |
| 10連の価格 | 3,000ぃえん |
| 資金補給条件 | 残高 < 3,000ぃえん（10連1回分未満） |
| 資金補給額 | 30,000ぃえん（10連10回分） |
| 補給タイミング | 0時（JST）以降の初回アクセス時に判定、1日1回 |
| 残高上限 | なし（MVP段階） |

**残高不足時の挙動**: 残高が3,000ぃえん未満の場合、ガチャボタンを無効化（disabled）し、「資金が足りません。0時に補給されます」のメッセージを表示する。MVPでは10連のみ（1連購入なし）。

---

## 4. 非機能要件

### NFR-01: パフォーマンス

| 項目 | 要件 |
|------|------|
| 初回ロード | 3秒以内（4G回線以上） |
| 抽選処理 | 10連ガチャの抽選〜結果表示が演出含め5秒以内 |
| 操作レスポンス | ボタン操作後のUI応答は200ms以内 |

### NFR-02: 可用性

| 項目 | 要件 |
|------|------|
| 稼働率 | Vercel無料枠のSLAに準拠（実質99.9%+） |

### NFR-03: 対応環境

| 項目 | 要件 |
|------|------|
| OS | iOS 15+, Android 10+, Windows 10+, macOS 12+ |
| ブラウザ | Chrome / Safari / Edge（各最新2バージョン） |
| 画面サイズ | 375px〜1920px（モバイルファースト） |

### NFR-04: セキュリティ

| 項目 | 要件 |
|------|------|
| 通信 | HTTPS必須（Vercel標準） |
| 個人情報 | 収集しない |
| データ改ざん | クライアント保存のため許容（MVP） |

### NFR-05: 保守性

| 項目 | 要件 |
|------|------|
| 確率テーブル | JSON設定ファイルとして外部化 |
| コード規約 | コメントは日本語、変数名・関数名は英語 |

### NFR-06: エラーハンドリング

| 項目 | 要件 |
|------|------|
| LocalStorage非対応 | 警告表示。セッション中はメモリで動作（M-13で実装） |
| データ破損 | 自動リセット（初期状態に復帰）（M-13で実装） |

### NFR-07: アクセシビリティ

| 項目 | 要件 |
|------|------|
| 最低限の対応 | alt属性、aria-label、キーボード操作対応 |

### NFR-08: テスト要件

| 項目 | 要件 |
|------|------|
| テスト必須有無 | **必須** |
| テストランナー | Vitest |
| 対象範囲 | ロジック層（抽選エンジン、通貨管理、資金補給判定）を重点的にテスト |
| カバレッジ最小目標 | ロジック層: 80%以上、全体: 60%以上 |
| CI自動実行 | GitHub Actions — push時に自動実行 |
| UIテスト | MVP段階では手動確認。将来的にPlaywright導入を検討 |

---

## 5. データモデル

### 5-1. エンティティ一覧

```
GameState (1件 — LocalStorage)
├── balance: number                    // 現在の所持金（ぃえん）
├── totalSpent: number                 // 累計購入額
├── totalWon: number                   // 累計当選額
├── totalTickets: number               // 累計購入枚数
├── totalDraws: number                 // 累計抽選回数（10連の回数）
├── winCountByLevel: Record<string, number>  // 等級別当選回数（例: {"1等": 0, "6等": 5}）
├── lastRefillDate: string             // 最終補給日（YYYY-MM-DD）
├── isFirstVisit: boolean              // 初回訪問フラグ
├── createdAt: string                  // 初回プレイ日時（ISO 8601）
└── updatedAt: string                  // 最終更新日時（ISO 8601）

DrawHistory (配列 — LocalStorage) ※GameStateと1:Nの関係
├── id: string                // 一意ID（UUID or timestamp）
├── timestamp: string         // 抽選日時（ISO 8601）
├── cost: number              // 購入額（3,000ぃえん）
├── totalWin: number          // この回の合計当選額
└── results: DrawResult[]     // 10枚分の結果（1:10固定、ネスト配列で非正規化保存）

DrawResult（DrawHistoryに埋め込み — 独立エンティティではない）
├── prizeLevel: string | null // 等級名（"1等", "6等", null=ハズレ）
└── amount: number            // 当選金額（0=ハズレ）

PrizeConfig (設定ファイル — コード内定数)
├── id: string               // 識別子（"nenmatsu-jumbo-2024"）
├── lotteryName: string      // "年末ジャンボ"
├── ticketPrice: number      // 300
├── version: string          // "1.0"
└── prizes: PrizeEntry[]     // 確率テーブル

PrizeEntry
├── level: string             // "1等"
├── amount: number            // 700000000
├── weight: number            // 本数/ユニット（1等=1, 7等=2000000）※整数で保持
└── displayName: string       // "1等 7億ぃえん"
```

### 5-2. リレーション

```
GameState (1) ──── (N) DrawHistory ──── (10固定) DrawResult（埋め込み）
                          │
PrizeConfig (設定) ────── 参照（MVPでは1種類固定）
```

- **GameState ↔ DrawHistory**: 1:N。GameStateは集計値（totalSpent, totalWon, winCountByLevel等）を独立保持し、DrawHistoryの件数制限に依存しない
- **DrawHistory ↔ DrawResult**: 1:10固定。DrawResultはDrawHistory内にネスト配列として非正規化保存
- **PrizeConfig**: コード内定数。MVPでは1種類固定。将来のC-01（複数宝くじ種類）対応時にDrawHistoryにlotteryTypeIdを追加予定

### 5-3. LocalStorageキー設計

| キー | 値の型 | 説明 |
|------|--------|------|
| `lottery-sim:gameState` | JSON (GameState) | ゲーム状態 |
| `lottery-sim:drawHistory` | JSON (DrawHistory[]) | 抽選履歴（直近100件） |
| `lottery-sim:version` | string | データスキーマバージョン（マイグレーション用） |

### 5-4. データ管理方針

| 項目 | 方針 |
|------|------|
| 履歴保持上限 | 直近100件。FIFO（古い順に物理削除） |
| 集計値と履歴の関係 | 集計値（totalSpent, totalWon, winCountByLevel等）はGameStateに独立保持。履歴削除で集計値は影響を受けない |
| データリセット | M-14により全データ物理削除（LocalStorageキーを全て削除し初期状態に復帰） |
| スキーマバージョニング | `lottery-sim:version`で管理。バージョン不一致時は旧データを変換するマイグレーション関数を実装する |

### 5-5. 命名規則

| 対象 | 規則 | 例 |
|------|------|-----|
| LocalStorageキー | `lottery-sim:` プレフィックス + camelCase | `lottery-sim:gameState` |
| TypeScript型名 | PascalCase | `GameState`, `DrawResult` |
| 変数・関数 | camelCase | `calculateWinnings`, `currentBalance` |
| 設定ファイル | camelCase | `prizeConfig.ts` |

---

## 6. 技術スタック

| レイヤー | 技術 | バージョン | 選定理由 |
|---------|------|----------|---------|
| フレームワーク | Next.js (App Router) | 15.x | SSGでSEO/OGP対応。Vercelとの親和性 |
| 言語 | TypeScript | 5.x | 型安全で個人開発の品質担保 |
| スタイリング | Tailwind CSS | 4.x | ユーティリティファースト。レスポンシブ対応が容易 |
| アニメーション | CSS Animations + Tailwind | - | 外部ライブラリ不要。軽量 |
| データ保存 | LocalStorage | - | サーバー不要。予算ゼロ適合 |
| ホスティング | Vercel（無料枠） | - | Next.jsとの最高の親和性。HTTPS標準 |
| テスト | Vitest + React Testing Library | - | 高速。Next.jsとの互換性良好 |
| CI | GitHub Actions | - | 無料枠で十分。push時にテスト自動実行 |
| パッケージマネージャ | npm | - | 標準的。追加設定不要 |

### バックエンド

MVP段階ではバックエンドなし（クライアントサイド完結）。

### 認証

MVP段階では認証なし。

---

## 7. MVP期間との整合性チェック

**MVP期間: 3週間（15営業日）**

### Must機能の工数見積もり

| # | 機能 | 見積もり | 備考 |
|---|------|---------|------|
| M-01 | ゲーム内通貨管理 | 0.5日 | LocalStorage CRUD + 状態管理 |
| M-02 | 10連ガチャUI | 1日 | 購入ボタン、残高不足UI、結果表示コンポーネント |
| M-03 | 抽選ロジック | 1日 | 整数重み付きランダム + テスト |
| M-04 | 当選結果表示 | 1日 | 10枚分の結果一覧UI |
| M-05 | 当選演出（簡易版） | 1日 | 当選/ハズレ2段階 + スキップ |
| M-06 | 毎日0時の資金補給 | 0.5日 | 日付判定ロジック（アクセス時チェック） |
| M-07 | 累計収支表示 | 1日 | GameState集計値の表示UI |
| M-08 | ギャンブル依存注意喚起 | 0.5日 | モーダル + フッター表示 |
| M-09 | 利用規約・免責表示 | 0.5日 | 静的ページ |
| M-10 | レスポンシブデザイン | 1日 | Tailwind CSS調整 |
| M-11 | データ永続化 | 0.5日 | LocalStorageラッパー |
| M-12 | SEO/OGP | 0.5日 | Next.js metadata API |
| M-13 | エラーハンドリング | 0.5日 | LocalStorage非対応警告 + データ破損時リセット |
| M-14 | データリセット | 0.5日 | 確認ダイアログ + 全データ削除 |
| - | プロジェクトセットアップ | 1日 | Next.js + Tailwind + Vitest + GitHub Actions |
| - | テスト作成 | 2日 | 抽選ロジック重点（確率分布検証含む） |
| - | ブラウザテスト・調整 | 1日 | クロスブラウザ確認 |
| **合計** | | **約13日（MVP期間の87%）** | **バッファ2日** |

### Should機能の追加工数

| # | 機能 | 見積もり |
|---|------|---------|
| S-01 | SNSシェア（テキスト） | 0.5日 |
| S-02 | 当選履歴一覧 | 1日 |
| S-03 | 等級別当選演出 | 1.5日 |
| **合計** | | **約3日** |

### Must機能間の依存関係

```
実装順序（クリティカルパス）:
M-11（データ永続化）→ M-01（通貨管理）→ M-03（抽選ロジック）→ M-02/M-04（ガチャUI/結果表示）→ M-05（演出）→ M-07（累計収支）

独立系（並行実装可能）:
M-06（資金補給）※M-01完了後
M-08（注意喚起）
M-09（利用規約）
M-10（レスポンシブ）
M-12（SEO/OGP）
M-13（エラーハンドリング）※M-11完了後
M-14（データリセット）※M-11完了後
```

### スコープ超過時の削減候補（優先度順）

遅延が発生した場合、以下の順で機能を簡素化・延期する:

1. **M-05をさらに簡素化**: 演出を完全にカットし、テキスト表示のみにする（-0.5日）
2. **M-07を最小限に**: 回収率のみ表示。等級別当選回数はShould降格（-0.5日）
3. **M-10をモバイルのみに**: デスクトップ最適化をShould降格（-0.5日）

### 判定

- **Must機能のみ**: 約13日 → **MVP期間15日の87%（バッファ2日確保: OK）**
- **Must + Should全部**: 約16日 → **3週間をやや超えるが、Shouldは工数に余裕がある場合のみ**
- **スコープ超過時の削減候補を3段階で定義済み**

---

## 8. 制約

| # | 制約 |
|---|------|
| C-01 | 現実の金銭を賭ける機能は実装しない（賭博罪回避） |
| C-02 | ゲーム内通貨の現金換金機能は実装しない |
| C-03 | 宝くじ公式のロゴ・デザインを使用しない（著作権回避） |
| C-04 | 宝くじの当選確率は現実の公式データに基づくこと |
| C-05 | ギャンブル依存症への配慮表示を必須とする |
| C-06 | リリース前に利用規約・免責事項を策定すること |
| C-07 | MVPでは10連ガチャのみ（1連購入なし） |

---

## 9. 懸念事項

| # | 懸念事項 | 深刻度 | 対策方針 |
|---|---------|--------|---------|
| R-01 | 法規制リスク（富くじ罪・刑法187条） | 高 | ゲーム内通貨「ぃえん」のみ・換金不可を明示。「シミュレーション」と明記 |
| R-02 | ギャンブル依存助長の批判 | 中 | 常時注意喚起表示、相談窓口リンク |
| R-03 | 継続率の低さ | 中 | 毎日0時の資金補給サイクル。将来版でリテンション施策を追加 |
| R-04 | クライアントサイドのデータ消失 | 中 | MVP段階では許容。M-14でリセット手段を提供 |
| R-05 | フリマ機能の法規制（将来） | 高 | 将来実装時に弁護士相談必須 |
| R-06 | クライアント時刻の改ざん | 低 | MVP段階では許容 |
| R-07 | LocalStorageの容量制限 | 低 | 履歴を直近100件に制限（FIFO） |

---

## 10. 用語定義

| 用語 | 定義 |
|------|------|
| ぃえん | 本サービスのゲーム内通貨。現実の通貨との交換はできない |
| 10連ガチャ | 宝くじ10枚を一括購入し抽選する操作 |
| 資金補給 | 0時（JST）以降の初回アクセス時に、所持金が3,000ぃえん未満のユーザーに30,000ぃえんを付与する仕組み |
| 当選確率テーブル | 各等級の当選確率を定義したデータ。2024年末ジャンボ準拠 |
| 回収率 | 累計当選額 / 累計購入額 x 100（%） |
| ユニット | 宝くじの発売単位。1ユニット=2,000万枚 |
| FIFO | First In, First Out。古いデータから順に削除する方式 |

---

## 完了条件チェック

- [x] Must機能がMVP期間に収まる（13日 / 15日 = 87%、バッファ2日）
- [x] データモデルが定義されている（セクション5、リレーション・管理方針含む）
- [x] 技術スタックが確定している（セクション6）
- [x] テスト要件が定義されている（NFR-08: Vitest、ロジック層80%、CI自動実行）
- [x] 申し送り事項が消化済み（SNSシェア→テキストのみで確定）
- [x] 要件定義書ファイルが piwf-output/lottery-simulator/ に出力されている
- [x] Must機能間の依存関係が定義されている（セクション7）
- [x] スコープ超過時の削減候補が定義されている（セクション7）

---

## 申し送りリスト（Phase 1 → Phase 2）

| # | 指摘事項 | 指摘者 | ランク | 対応期限 | ステータス |
|---|---|---|---|---|---|
| 1 | PrizeConfigのid/versionフィールドはMVPでは単一種類のため活用しないが、将来のC-01対応時にDrawHistoryにlotteryTypeIdを追加する前提で設計に留意 | データレビュー | 将来 | v2以降 | 持ち越し |
| 2 | データスキーマバージョニングの具体的なマイグレーション戦略はPhase 2で設計する | データレビュー | 将来 | Phase 2 | 持ち越し |
| 3 | Tailwind CSS v4はv3から設定方法が大幅変更。セットアップ時に学習コストを考慮すること | スコープレビュー | 将来 | Phase 2 | 持ち越し |

---

作成日: 2026-02-10
